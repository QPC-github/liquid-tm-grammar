# This file is shared and exists so that we don't repeat ourselves in
# liquid.YAML-tmLanguage and liquid-injection.YAML-tmLanguage. Our
# build tool will merge these into the other files.
repository:

  # block comments
  comment_block:
    begin: '{%-?\s*comment\s*-?%}'
    end: '{%-?\s*endcomment\s*-?%}'
    name: comment.block.liquid

  # new comment syntax
  comment_inline:
    begin: '{%-?\s*#'
    end: '-?%}'
    name: comment.line.number-sign.liquid

  assign_op:
    patterns:
      - match: /=
        name: keyword.operator.assignment.augmented.liquid

  logic_expression:
    patterns:
      - match: /=
        name: keyword.operator.assignment.augmented.liquid

  logic_op:
    patterns:
      - match: \s+(and|or|not|contains|(\!\=|\=\=|<\=|>\=|<|>)\s+
        name: keyword.operator.logical.liquid

  # TODO this is broken. We should go in different branches.
  # template_var is too generic.
  # tag:
  #   patterns:
  #     - include: '#liquid-tag'
  #     - include: '#tag'

  template_tag_name:
    patterns:
      - match: '(?<={%)\s*\b(else|break|continue)\b'
        name: keyword.control.liquid
      - match: '(?<={%)\s*\b(if|unless|else|eslif|endunless|endif)\b'
        name: keyword.control.conditional.liquid
      - match: '(?<={%)\s*\b(for|endfor|cycle|tablerow|endtablerow)\b'
        name: keyword.control.loop.liquid
      - match: '(?<={%)\s*\b(case|when|endcase)\b'
        name: keyword.control.switch.liquid
      - match: '(?<={%)\s*(\w+)'
        name: entity.name.tag.liquid
      - match: '(?<={%-)\s*(\w+)'
        name: entity.name.tag.liquid

  template_tag_keyword:
    patterns:
      - match: '\b(reversed|in):'
        name: keyword.control.liquid
      - match: '\b(cols|offset|limit):'
        name: keyword.control.liquid

  template_var:
    patterns:
        # TODO ???
      - match: '(\[)(\|)(?=[^\]]*)(?=\])'
        captures:
          '2': { name: invalid.illegal.filter.liquid }
          '3': { name: invalid.illegal.filter.liquid }

        # TODO ???
      - match: '(?<=\s)(\+|\-|\/|\*)(?=\s)'
        name: invalid.illegal.filter.liquid

        # constants
      - match: (false|true|nil|blank)
        name: constant.language.liquid

        # TODO ??
      - captures:
          '3': { name: invalid.illegal.operator.liquid }
        match: '(?=if|unless|elsif)\s*[^%}]+\s(in)\s'

        # operators
      - match: \s+(and|or|not|contains|in|by|((\!|\=|\<|\>)\=))\s+
        name: keyword.operator.expression.liquid

        # TODO ???
      - captures:
          '2': { name: invalid.illegal.assignment.liquid }
        match: '(?<=assign)([^\=]+)(\=\=+)'

        # filter with args (e.g. "at_most" in `| at_most: 1` )
      - match: '\|\s+(?![\.0-9])[a-zA-Z0-9_-]+\:\s+'
        name: support.function.with-args.liquid

        # filter without args (e.g. "first" in `| first` )
      - match: '\|\s+(?![\.0-9])[a-zA-Z0-9_-]+\s+'
        name: support.function.without-args.liquid

        # TODO ???
      - match: '(?<=\s)(with|offset\:|limit\:)(?=\s)'
        name: keyword.control.liquid

        # TODO ???
      - captures:
          '2': { name: invalid.illegal.argument.liquid }
        match: '(?<=include)(.*)(with\:|offset|limit)(?=\s)'

        # TODO ???
      - match: '(?<=\s)(\w+\:)(?=\:\s)'
        name: invalid.illegal.liquid

        # double quotes
      - begin: '"'
        end: '"'
        name: string.quoted.double.liquid

        # single quotes
      - begin: "'"
        end: "'"
        name: string.quoted.single.liquid

        # numbers
      - match: '(-|\+)?\s*[0-9]+(\.[0-9]+)?'
        name: constant.numeric.liquid

        # Stuff provided by the language has its own colour
      - match: \b(<%= ANY_GLOBAL_OBJECT %>)\b
        name: variable.language.liquid

        # a parameter name following a colon. e.g. "var" in `product: var`
      - match: '((?<=\w\:\s)\w+)'
        name: variable.parameter.liquid

        # what follows the dot in a variable
      - match: '(?<=\.)\w+\b'
        name: support.variable.liquid

        # Must be a variable...
      - match: \w+
        name: variable.other.liquid
